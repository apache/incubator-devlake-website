<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Apache DevLake (Incubating) Blog</title>
        <link>https://devlake.apache.org/zh/blog</link>
        <description>Apache DevLake (Incubating) Blog</description>
        <lastBuildDate>Fri, 17 Jun 2022 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh</language>
        <item>
            <title><![CDATA[Apache DevLake 兼容 PostgreSQL 踩坑小结]]></title>
            <link>https://devlake.apache.org/zh/blog/some-practices-of-supporting-postgresql</link>
            <guid>some-practices-of-supporting-postgresql</guid>
            <pubDate>Fri, 17 Jun 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[本文作者：ZhangLiang]]></description>
            <content:encoded><![CDATA[<p>本文作者：ZhangLiang<br>
<!-- -->个人主页：<a href="https://github.com/mindlesscloud" target="_blank" rel="noopener noreferrer">https://github.com/mindlesscloud</a></p><p>Apache DevLake 是一个研发数据平台，可以收集和整合各类研发工具的数据，比如 Jira、Github、Gitlab、Jenkins。</p><p><strong>本文并不打算对数据库兼容这个问题做全面的总结，只是对我们实际遇到的问题做一个记录，希望能对有相似需求的人提供一个参考。</strong></p><p><strong>1、数据类型差异</strong></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="postgresql-不支持-uint-类型的数据类型">PostgreSQL 不支持 uint 类型的数据类型<a class="hash-link" href="#postgresql-不支持-uint-类型的数据类型" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> JenkinsBuild </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoPKModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JobName           </span><span class="token builtin">string</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">`gorm:"primaryKey;type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Duration          </span><span class="token builtin">float64</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// build time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DisplayName       </span><span class="token builtin">string</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// "#7"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EstimatedDuration </span><span class="token builtin">float64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Number            </span><span class="token builtin">int64</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"primaryKey;type:INT(10) UNSIGNED NOT NULL"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Result            </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Timestamp         </span><span class="token builtin">int64</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// start time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StartTime         time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time </span><span class="token comment" style="color:#999988;font-style:italic">// convered by timestamp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CommitSha         </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>其中的<code>JenkinsBuild.Number</code>字段的<code>gorm</code> struct tag 使用了<code>UNSIGNED</code>会导致建表失败，需要去掉。</p><p><img loading="lazy" src="/zh/assets/images/df2f9837-121e-4a64-976c-c5039d452bfd-f129f63a0aad6218d9040f3eb2917990.png" width="3730" height="236" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="mysql-没有-bool-型">MySQL 没有 bool 型<a class="hash-link" href="#mysql-没有-bool-型" title="标题的直接链接">​</a></h3><p>对于 model 里定义为 bool 型的字段，gorm 会把它映射成 MySQL 的 TINYINT 类型，在 SQL 里可以直接用 0 或者 1 查询，但是 PostgreSQL 里是有 bool 类型的，所以 gorm 会把它映射成 BOOL 类型，如果 SQL 里还是用的 0 或者 1 去查询就会报错。</p><p>以下是一个具体的例子（为了清晰起见我们删掉了无关的字段），下面的查询语句在 MySQL 里是没有问题的，但是在  PostgreSQL 上就会报错。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GitlabMergeRequestNote </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergeRequestId  </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:"index"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System          </span><span class="token builtin">bool</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"merge_request_id = ? AND `system` = 0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>语句改成这样后仍然会有错误，具体请见下面关于反引号的问题。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"merge_request_id = ? AND `system` = ?"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>2、行为差异</strong></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="批量插入">批量插入<a class="hash-link" href="#批量插入" title="标题的直接链接">​</a></h3><p>如果使用了<code>ON CONFLIT UPDATE ALL</code>从句批量插入的时候，本批次如果有多条主键相同的记录会导致 PostgreSQL 报错，MySQL 则不会。</p><p><img loading="lazy" src="/zh/assets/images/efea0188-80e4-4519-a010-977a7fd5432e-24bf2c80d325f021cfb13cd26652aec9.png" width="3718" height="634" class="img_E7b_"></p><p><img loading="lazy" src="/zh/assets/images/7b2a6f29-ea2a-4a84-97c8-7eba5a5131a8-ecef21ecd88f5e7e73b4ba15818892d4.png" width="3712" height="184" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="字段类型-model-定义与-schema-不一致">字段类型 model 定义与 schema 不一致<a class="hash-link" href="#字段类型-model-定义与-schema-不一致" title="标题的直接链接">​</a></h3><p>例如在 model 定义中<code>GithubPullRequest.AuthorId</code>是 int 类型，但是数据库里这个字段是 VARCHAR 类型，插入数据的时候 MySQL 是允许的，PostgreSQL 则会报错。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GithubPullRequest </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GithubId        </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:"primaryKey"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RepoId          </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:"index"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Number          </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:"index"`</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    State           </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Title           </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GithubCreatedAt time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GithubUpdatedAt time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time </span><span class="token string" style="color:#e3116c">`gorm:"index"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClosedAt        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In order to get the following fields, we need to collect PRs individually from GitHub</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Additions      </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Deletions      </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Comments       </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Commits        </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReviewComments </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Merged         </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergedAt       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Body           </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type           </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Component      </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergeCommitSha </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(40)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HeadRef        </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BaseRef        </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BaseCommitSha  </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HeadCommitSha  </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Url            </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(255)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorName     </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:"type:varchar(100)"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorId       </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoPKModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" src="/zh/assets/images/8afb097c-a0b3-4bdc-80f3-7241c3fa566f-05d6a3d073455a2d728f33dedce09593.png" width="3718" height="224" class="img_E7b_"></p><p><strong>3、MySQL 特有的函数</strong></p><p>在一个复杂查询中我们曾经使用了 <code>GROUP_CONCAT</code> 函数，虽然 PostgreSQL 中有功能类似的函数但是函数名不同，使用方式也有细微差别。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cursor2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"pull_requests pr1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Joins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"left join pull_requests pr2 on pr1.parent_pr_id = pr2.id"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Group</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"pr1.parent_pr_id, pr2.created_date"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"pr1.parent_pr_id != ''"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Joins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"left join repos on pr2.base_repo_id = repos.id"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Order</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"pr2.created_date ASC"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">`pr2.key as parent_pr_key, pr1.parent_pr_id as parent_pr_id, GROUP_CONCAT(pr1.base_ref order by pr1.base_ref ASC) as cherrypick_base_branches, </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            GROUP_CONCAT(pr1.key order by pr1.base_ref ASC) as cherrypick_pr_keys, repos.name as repo_name, </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            concat(repos.url, '/pull/', pr2.key) as parent_pr_url`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Rows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>解决方案：
我们最终决定把<code>GROUP_CONCAT</code>函数的功能拆分成两步，先用最简单的 SQL 查询得到排序好的多条数据，然后用代码做聚合。</p><p>修改后：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cursor2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">`</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            SELECT pr2.pull_request_key                 AS parent_pr_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr1.parent_pr_id                     AS parent_pr_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr1.base_ref                         AS cherrypick_base_branch,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr1.pull_request_key                 AS cherrypick_pr_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   repos.NAME                           AS repo_name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   Concat(repos.url, '/pull/', pr2.pull_request_key) AS parent_pr_url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr2.created_date</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            FROM   pull_requests pr1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   LEFT JOIN pull_requests pr2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                          ON pr1.parent_pr_id = pr2.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   LEFT JOIN repos</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                          ON pr2.base_repo_id = repos.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            WHERE  pr1.parent_pr_id != ''</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ORDER  BY pr1.parent_pr_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                      pr2.created_date,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                      pr1.base_ref ASC</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            `</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Rows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>4、语法差异</strong></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="反引号">反引号<a class="hash-link" href="#反引号" title="标题的直接链接">​</a></h3><p>某些 SQL 语句中我们使用了反引号，用来保护字段名，以免跟 MySQL 保留字有冲突，这种做法在 PostgreSQL 会导致语法错误。为了解决这个问题我们重新审视了我们的代码，把所有跟保留字冲突的字段名做了修改，同时去掉了 SQL 语句中的反引号。例如刚才提到的这个例子：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"merge_request_id = ? AND `system` = ?"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>解决方案：我们把<code>system</code>改个名字<code>is_system</code>，这样就可以把反引号去掉。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"merge_request_id = ? AND is_system = ?"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="不规范的删除语句">不规范的删除语句<a class="hash-link" href="#不规范的删除语句" title="标题的直接链接">​</a></h3><p>我们的代码中曾经出现过这种删除语句，这在 MySQL 中是合法的，但是在 PostgreSQL 中会报语法错误。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Exec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">`</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    DELETE ic</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    FROM jira_issue_commits ic</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    LEFT JOIN jira_board_issues bi ON (bi.source_id = ic.source_id AND bi.issue_id = ic.issue_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    WHERE ic.source_id = ? AND bi.board_id = ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    `</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> boardId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>解决方案：我们把<code>DELETE</code>后面的表别名去掉就可以了。</p><p><strong>了解更多最新动态</strong></p><p>官网：<a href="https://devlake.incubator.apache.org/" target="_blank" rel="noopener noreferrer">https://devlake.incubator.apache.org/</a></p><p>GitHub：<a href="https://github.com/apache/incubator-devlake/" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-devlake/</a></p><p>Slack：通过 <a href="https://devlake-io.slack.com/join/shared_invite/zt-18uayb6ut-cHOjiYcBwERQ8VVPZ9cQQw#/shared-invite/email" target="_blank" rel="noopener noreferrer">Slack</a> 联系我们</p>]]></content:encoded>
            <category>devlake</category>
            <category>database</category>
            <category>postgresql</category>
        </item>
        <item>
            <title><![CDATA[Apache DevLake代码库导览]]></title>
            <link>https://devlake.apache.org/zh/blog/apache-devlake-codebase-walkthrough</link>
            <guid>apache-devlake-codebase-walkthrough</guid>
            <pubDate>Mon, 06 Jun 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Apache DevLake是什么？]]></description>
            <content:encoded><![CDATA[<h3 class="anchor anchorWithStickyNavbar_mojV" id="apache-devlake是什么">Apache DevLake是什么？<a class="hash-link" href="#apache-devlake是什么" title="标题的直接链接">​</a></h3><p>研发数据散落在软件研发生命周期的不同阶段、不同工作流、不同DevOps工具中，且标准化程度低，导致效能数据难以留存、汇集并转化为有效洞见。为了解决这一痛点，<a href="https://github.com/apache/incubator-devlake" target="_blank" rel="noopener noreferrer">Apache DevLake</a> 应运而生。Apache DevLake是一款开源的研发数据平台，它通过提供自动化、一站式的数据收集、分析以及可视化能力，帮助研发团队更好地理解开发过程，挖掘关键瓶颈与提效机会。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="apache-devlake架构概述">Apache DevLake架构概述<a class="hash-link" href="#apache-devlake架构概述" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/zh/assets/images/Architecture_Diagram-f52640e8c40d052f526ed8283e2833e5.png" width="1262" height="641" class="img_E7b_"></p><center>Apache DevLake 架构图</center><br><ul><li>Config UI: 人如其名，配置的可视化，其主要承载Apache DevLake的配置工作。通过Config UI，用户可以建立数据源连接，并实现数据的收集范围，部分数据的转换规则，以及收集频率等任务。</li><li>Api Sever：Apache DevLake的Api接口，是前端调用后端数据的通道。</li><li>Runner：Apache DevLake运行的底层支撑机制。</li><li>Plugins：具体执行的插件业务，主要承载Apache DevLake的后端数据收集、扩展和转换的工作。除dbt插件外的插件产出Apache DevLake的预置数据，预置数据主要包括三层；<ul><li>raw layer：负责储存最原始的api response json。</li><li>tool layer：根据raw layer提取出此插件所需的数据。</li><li>domain layer：根据tool layer层抽象出共性的数据，这些数据会被使用在Grafana图表中，用于多种研发指标的展示。</li></ul></li><li>RDBS: 关系型数据库。目前Apache DavLake支持MySQL和PostgreSQL，后期还会继续支持更多的数据库。</li><li>Grafana Dashboards: 其主要承载Apache DevLake的前端展示工作。根据Apache DevLake收集的数据，通过sql语句来生成团队需要的交付效率、质量、成本、能力等各种研发效能指标。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="目录结构tree">目录结构Tree<a class="hash-link" href="#目录结构tree" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── blueprints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── docs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── domainlayer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── pipelines</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── push</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── shared</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; └── version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── devops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; └── lake-builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── e2e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── _archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── dashboards</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; └── provisioning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     ├── dashboards</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     └── datasources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── logger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── migration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── domainlayer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── crossdomain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── devops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── didgen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── ticket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── ae</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── dbt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── feishu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── apimodels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── gitextractor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── parser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── github</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── gitlab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── e2e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; └── tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── impl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── helper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── jenkins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── jira</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp;     └── apiv2models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── refdiff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; └── tapd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     ├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     ├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     │&nbsp;&nbsp; └── migrationscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     │&nbsp;&nbsp;     └── archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp;     └── tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── releases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── lake-v0.10.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── lake-v0.10.0-beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── lake-v0.10.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── lake-v0.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── lake-v0.8.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; └── lake-v0.9.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; ├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; │&nbsp;&nbsp; └── task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│&nbsp;&nbsp; └── example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── testhelper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── docker-compose.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── docker-compose-temporal.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── k8s-deploy.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── .env.exemple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="目录导览">目录导览<a class="hash-link" href="#目录导览" title="标题的直接链接">​</a></h3><ul><li>后端部分：<ul><li>config：对.env配置文件的读、写以及修改的操作。</li><li>logger：log日志的level、format等设置。</li><li>errors：Error的定义。</li><li>utils：工具包，它包含一些基础通用的函数。</li><li>runner：提供基础执行服务，包括数据库，cmd，pipelines，tasks以及加载编译后的插件等基础服务。</li><li>models：定义框架级别的实体。<ul><li>common：基础struct定义。</li><li><a href="https://devlake.apache.org/docs/DataModels/DevLakeDomainLayerSchema" target="_blank" rel="noopener noreferrer">domainlayer</a>：领域层是来自不同工具数据的通用抽象。<ul><li>ticket：Issue Tracking，即问题跟踪领域。</li><li>code：包括Source Code源代码关联领域。以及Code Review代码审查领域。</li><li>devops：CI/CD，即持续集成、持续交付和持续部署领域。</li><li>crossdomain：跨域实体，这些实体用于关联不同领域之间的实体，这是建立全方面分析的基础。</li><li>user：对用户的抽象领域，user也属于crossdomain范畴。</li></ul></li><li>migrationscripts：初始化并更新数据库。</li></ul></li><li>plugins：<ul><li>core：插件通用接口的定义以及管理。</li><li>helper：插件通用工具的集合，提供插件所需要的辅助类，如api收集，数据ETL，时间处理等。<ul><li>网络请求Api Client工具。</li><li>收集数据Collector辅助类，我们基于api相同的处理模式，统一了并发，限速以及重试等功能，最终实现了一套通用的框架，极大地减少了开发和维护成本。</li><li>提取数据Extractor辅助类，同时也内建了批量处理机制。</li><li>转换数据Convertor辅助类。</li><li>数据库处理工具。</li><li>时间处理工具。</li><li>函数工具。</li></ul></li><li>ae：分析引擎，用于导入merico ae分析引擎的数据。</li><li>feishu：收集飞书数据，目前主要是获取一段时间内组织内会议使用的top用户列表的数据。</li><li>github：收集Github数据并计算相关指标。（其他的大部分插件的目录结构和实现功能和github大同小异，这里以github为例来介绍）。<ul><li>github.go：github启动入口。</li><li>tasks：具体执行的4类任务。<ul><li>*_collector.go：收集数据到raw layer层。</li><li>*_extractor.go：提取所需的数据到tool layer层。</li><li>*_convertor.go：转换所需的数据到domain layer层。</li><li>*_enricher.go：domain layer层更进一步的数据计算转换。</li></ul></li><li>models：定义github对应实体entity。</li><li>api：api接口。</li><li>utils：github提取的一些基本通用函数。</li></ul></li><li>gitextractor：git数据提取工具，该插件可以从远端或本地git仓库提取commit和reference信息，并保存到数据库或csv文件。用来代替github插件收集commit信息以减少api请求的数量，提高收集速度。</li><li>refdiff：在分析开发工作产生代码量时，经常需要知道两个版本之间的diff。本插件基于数据库中存储的commits父子关系信息，提供了计算ref(branch/tag)之间相差commits列表的能力。</li><li>gitlab：收集Gitlab数据并计算相关指标。</li><li>jenkins：收集jenkins的build和job相关指标。</li><li>jira：收集jira数据并计算相关指标。</li><li>tapd：收集tapd数据并计算相关指标。</li><li>dbt：(data build tool)是一款流行的开源数据转换工具，能够通过SQL实现数据转化，将命令转化为表或者视图，提升数据分析师的工作效率。Apache DevLake增加了dbt插件，用于数据定制的需要。</li></ul></li><li>services：创建、管理Apache DevLake各种服务，包含notifications、blueprints、pipelines、tasks、plugins等。</li><li>api：使用Gin框架搭建的一个通用Apache DevLake API服务。</li></ul></li><li>前端部分：<ul><li>congfig-ui：主要是Apache DevLake的插件配置信息的可视化。<a href="https://devlake.apache.org/docs/Glossary" target="_blank" rel="noopener noreferrer">一些术语的解释</a><ul><li>常规模式 <ul><li>blueprints的配置。</li><li>data connections的配置。</li><li>transformation rules的配置。</li></ul></li><li>高级模式：主要是通过json的方式来请求api，可选择对应的插件，对应的subtasks，以及插件所需要的其他信息。</li></ul></li><li>Grafana：其主要承载Apache DevLake的前端展示工作。根据收集的数据，通过sql语句来生成团队需要的各种数据。目前sql主要用domain layer层的表来实现通用数据展示需求。</li></ul></li><li>migration：数据库迁移工具。<ul><li>migration：数据库迁移工具migration的具体实现。</li><li>models/migrationscripts：domian layer层的数据库迁移脚本。</li><li>plugins/xxx/models/migrationscripts：插件的数据库迁移脚本。主要是<em>raw</em>和<em>tool</em>开头的数据库的迁移。</li></ul></li><li>测试部分：<ul><li>testhelper和plugins下的*_test.go文件：即单元测试，属于白盒测试范畴。针对目标对象自身的逻辑，执行路径的正确性进行测试，如果目标对象有依赖其它资源或对够用，采用注入或者 mock 等方式进行模拟，可以比较方便地制造一些难以复现的极端情况。</li><li>test：集成测试，灰盒测试范畴。在单元测试的基础上，将所有模块按照设计要求（如根据结构图）组装成为子系统或系统，进行集成测试。</li><li>e2e： 端到端测试，属于黑盒测试范畴。相对于单元测试更注重于目标自身，e2e更重视目标与系统其它部分互动的整体正确性，相对于单元测试着重逻辑测试，e2e侧重于输出结果的正确性。</li></ul></li><li>编译，发布部分：<ul><li>devops/lake-builder： mericodev/lake-builder的docker构建。</li><li>Dockerfile：主要用于构建devlake镜像。</li><li>docker-compose.yml：是用于定义和运行多容器Docker应用程序的工具，用户可以使用YML文件来配置Apache DevLake所需要的服务组件。</li><li>docker-compose-temporal.yml：Temporal是一个微服务编排平台，以分布式的模式来部署Apache DevLake，目前处于试验阶段，仅供参考。</li><li>worker：Temporal分布式部署形式中的worker实现，目前处于试验阶段，仅供参考。</li><li>k8s-deploy.yaml：Kubernetes是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。目前Apache DevLake已支持在k8s集群上部署。</li><li>Makefile：是一个工程文件的编译规则，描述了整个工程的编译和链接等规则。</li><li>releases：Apache DevLake历史release版本的配置文件，包括docker-compose.yml和env.example。</li><li>scripts：shell脚本，包括编译plugins脚本。</li></ul></li><li>其他：<ul><li>img：logo、社区微信二维码等图像信息。</li><li>version：实现版本显示的支持，在正式的镜像中会显示对应release的版本。</li><li>.env.exemple：配置文件实例，包括DB URL, LOG以及各插件的配置示例信息。</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="如何联系我们">如何联系我们<a class="hash-link" href="#如何联系我们" title="标题的直接链接">​</a></h3><ul><li>Github地址：<a href="https://github.com/apache/incubator-devlake" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-devlake</a></li><li>官网地址：<a href="https://devlake.apache.org/" target="_blank" rel="noopener noreferrer">https://devlake.apache.org/</a></li><li><a href="https://join.slack.com/t/devlake-io/shared_invite/zt-18uayb6ut-cHOjiYcBwERQ8VVPZ9cQQw" target="_blank" rel="noopener noreferrer">Slack</a>: 通过Slack联系</li><li>微信联系:<br><img loading="lazy" alt="img" src="data:image/png;base64,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" width="300" height="300" class="img_E7b_"></li></ul>]]></content:encoded>
            <category>devlake</category>
            <category>codebase</category>
        </item>
        <item>
            <title><![CDATA[如何贡献issue]]></title>
            <link>https://devlake.apache.org/zh/blog/2022/05/20/如何贡献issues</link>
            <guid>/2022/05/20/如何贡献issues</guid>
            <pubDate>Fri, 20 May 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[上周(2022-05-12)，我们以先到先得的方式为大家列出了两个"good first issue"。]]></description>
            <content:encoded><![CDATA[<p>上周(2022-05-12)，我们以先到先得的方式为大家列出了两个"good first issue"。
这很有趣，它们几乎立刻就被拿走了......
但对于那些有兴趣但没有得到的人来说可能就不那么有趣了。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="所以">所以...<a class="hash-link" href="#所以" title="标题的直接链接">​</a></h3><p>我们决定，不再有竞争，你可以从我们的github issue pages中挑选你喜欢的issue。如果没有了，甚至可以创建你自己的。
我们毕竟是社区！</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="怎么做呢这很简单">怎么做呢？这很简单!<a class="hash-link" href="#怎么做呢这很简单" title="标题的直接链接">​</a></h3><p>进入我们的<a href="https://github.com/apache/incubator-devlake/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22" target="_blank" rel="noopener noreferrer">问题页面</a>，然后点击这里。我们所有的Good First Issue都列在这里!
<img loading="lazy" alt="good first issue" src="/zh/assets/images/issue_page_screenshot-4aa3f48811d5bc6aa1a36ce71727344c.png" width="1320" height="266" class="img_E7b_"></p><ul><li><p>首先，寻找现有的issues，找到一个你喜欢的。
你可以通过评论"I'll take it!"来预订它。
接下来你可以写一份“攻略”，以展示你对问题的理解和你将采取什么样的步骤来解决这个issue，然后开始Coding。</p></li><li><p>如果没有GFI了怎么办？创造你自己的issue! 现在，通过查看我们的代码库。
你肯定能发现很多问题，比如文档、单元测试，甚至是错字。
把你觉得不对的地方提出来，我们会验证它是否必要，
然后你就可以开始Coding了。</p></li><li><p>最后，你可能会问，我为什么要费尽心思为你写代码？
不不不，你不是为我们写代码，你是为社区里的每个人写代码，你是为自己写代码。
为了提高你的技能，为了学习如何与他人合作。而对于那些做出重大贡献的人，
我们为您提供一个Apache Committer的席位，甚至是PPMC！</p></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="就这些了有任何问题请随时提出编码快乐">就这些了，有任何问题请随时提出。编码快乐！<a class="hash-link" href="#就这些了有任何问题请随时提出编码快乐" title="标题的直接链接">​</a></h3>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[DevLake 加入 Apache 孵化器，来和我们一起玩开源！]]></title>
            <link>https://devlake.apache.org/zh/blog/apache-welcomes-devlake</link>
            <guid>apache-welcomes-devlake</guid>
            <pubDate>Wed, 18 May 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[4 月 29 日，开源研发数据平台 DevLake 通过投票决议，正式成为 Apache 软件基金会 (ASF) 的孵化项目。]]></description>
            <content:encoded><![CDATA[<p>4 月 29 日，开源研发数据平台 DevLake 通过投票决议，正式成为 Apache 软件基金会 (ASF) 的孵化项目。</p><p><img loading="lazy" alt="incubation" src="/zh/assets/images/incubation-screenshot-4dc642e1d68b6d7ec457d3e352c32053.jpg" width="1356" height="690" class="img_E7b_"></p><p>进入孵化器后，DevLake 将遵循 <a href="https://www.apache.org/theapacheway/index.html" target="_blank" rel="noopener noreferrer">The Apache Way</a>，在导师们的引导下，坚持以人为本、社区高于代码的理念，持续建设包容、多元、崇尚知识的社区。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="devlake-主要特性">DevLake 主要特性<a class="hash-link" href="#devlake-主要特性" title="标题的直接链接">​</a></h3><p>作为开源的研发数据平台，DevLake 向软件研发团队提供自动化、一站式的数据收集、分析以及可视化能力，帮助研发团队借助数据更好地理解开发过程，挖掘关键瓶颈与提效机会。 </p><h4 class="anchor anchorWithStickyNavbar_mojV" id="归集-devops-全流程效能数据连接数据孤岛">归集 DevOps 全流程效能数据，连接数据孤岛<a class="hash-link" href="#归集-devops-全流程效能数据连接数据孤岛" title="标题的直接链接">​</a></h4><p>针对 DevOps 工具链复杂、数据收集难的痛点，DevLake 将需求-设计-开发-测试-交付-运营全流程、不同工具的效能数据汇集于一个平台，避免用户重复造轮子。</p><p>这些数据可以互相关联分析，进而更加准确、全面地刻画研发过程。举个例子，在了解项目 bug 修复的近况时，不仅可以了解已修复 bug 的个数，还可以了解这些 bug 的分布、bug 修复相关的代码工作量、所占总工作量比例等信息。</p><p>当前 DevLake 已支持主流项目管理工具 <a href="https://github.com/apache/incubator-devlake/tree/main/plugins/jira" target="_blank" rel="noopener noreferrer">JIRA cloud</a>、<a href="https://github.com/apache/incubator-devlake/tree/main/plugins/jira" target="_blank" rel="noopener noreferrer">JIRA server</a>、<a href="https://github.com/apache/incubator-devlake/tree/main/plugins/tapd" target="_blank" rel="noopener noreferrer">TAPD</a>，代码托管工具 <a href="https://github.com/apache/incubator-devlake/tree/main/plugins/gitextractor" target="_blank" rel="noopener noreferrer">Git</a>、<a href="https://github.com/apache/incubator-devlake/tree/main/plugins/github" target="_blank" rel="noopener noreferrer">GitHub</a>、<a href="https://github.com/apache/incubator-devlake/tree/main/plugins/gitlab" target="_blank" rel="noopener noreferrer">GitLab</a>，CI/CD 工具 <a href="https://github.com/apache/incubator-devlake/tree/main/plugins/jenkins" target="_blank" rel="noopener noreferrer">Jenkins</a>，日历工具<a href="https://github.com/apache/incubator-devlake/tree/main/plugins/feishu" target="_blank" rel="noopener noreferrer">飞书日历</a>。</p><p>数据源列表正在快速拓展中，您可以查看 Apache DevLake 已支持数据的<a href="https://devlake.apache.org/docs/DataModels/DataSupport" target="_blank" rel="noopener noreferrer">详细文档</a>，同时非常欢迎<a href="https://github.com/apache/incubator-devlake/blob/main/plugins/README.md" target="_blank" rel="noopener noreferrer">参与贡献新的数据源插件</a>！</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="标准化研发数据模型和开箱即用的效能指标">标准化研发数据模型和开箱即用的效能指标<a class="hash-link" href="#标准化研发数据模型和开箱即用的效能指标" title="标题的直接链接">​</a></h4><p>研发过程数据的标准化程度低，用户难以直接使用这些数据进一步分析；而效能指标定义与计算方法模糊，又给研发数据的应用带来了额外的成本。</p><p>Apache DevLake 提供了便捷的数据转化能力，将收集来的数据清洗转换为<a href="https://devlake.apache.org/docs/DataModels/DevLakeDomainLayerSchema" target="_blank" rel="noopener noreferrer">标准数据模型</a>，并基于标准模型生成一系列<a href="https://devlake.apache.org/docs/EngineeringMetrics" target="_blank" rel="noopener noreferrer">研发效能指标</a>，对用户来说简单易懂、开箱即用。一方面节省了治理数据和定义指标的成本，另一方面使效能指标更加透明，便于研发数据的应用落地。</p><p>目前 Apache DevLake 已支持 20+常见研发效能指标，可应用于交付效率、质量、成本、能力等不同认知域。</p><p>结合用户使用研发数据的具体场景，Apache DevLake 基于 Grafana 搭建数据看板，支持趋势分析、按照成员/阶段下钻等分析能力，帮助用户快速定位研发效能提升的关键环节。您可以查看<a href="https://devlake.apache.org/docs/LiveDemo" target="_blank" rel="noopener noreferrer">预设数据看板</a>，后续我们将在 blog 中介绍每一个数据看板及其背后的真实用户场景。</p><p><img loading="lazy" alt="面向开源产品的版本/模块质量分析" src="/zh/assets/images/Dashboard-1-0bd59aa8caf7e5684cc1359e0d82709a.jpg" width="1451" height="750" class="img_E7b_"></p><p><img loading="lazy" alt="面向开源产品的版本/模块质量分析" src="/zh/assets/images/Dashboard-2-d239627397b177b7108f0fc66b60dbbd.jpg" width="1447" height="896" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="灵活的数据源插件系统及数据处理框架支持自定义">灵活的数据源插件系统及数据处理框架，支持自定义<a class="hash-link" href="#灵活的数据源插件系统及数据处理框架支持自定义" title="标题的直接链接">​</a></h4><p>Apache DevLake 将数据加工、关联与转换的底层能力开放出来，提供可拓展的数据底座。
用户可以根据实际需求，实现以下自定义：</p><ul><li>数据源自定义：Apache DevLake 基于 Golang plugin 系统设计了灵活的插件系统，支持用户独立开发接入任意 DevOps 工具</li><li>数据实体自定义：基于 dbt 插件，支持用户自定义数据转换模型</li><li>效能指标自定义：支持用户基于数据模型自定义指标，或调整指标计算方式</li><li>数据看板自定义：SQL 查询，在 Grafana 中拖拽搭建数据看板</li></ul><p>以下是 <a href="https://github.com/apache/incubator-devlake/blob/main/ARCHITECTURE.md" target="_blank" rel="noopener noreferrer">Apache DevLake 架构图</a>：</p><p><img loading="lazy" alt="面向开源产品的版本/模块质量分析" src="/zh/assets/images/0.11-architecture-diagram-f422e47efad0b84f72eb3bc51c7d1f1b.jpg" width="2143" height="1182" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="未来规划">未来规划<a class="hash-link" href="#未来规划" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="技术与产品方面">技术与产品方面<a class="hash-link" href="#技术与产品方面" title="标题的直接链接">​</a></h4><ul><li>集成更多数据源，覆盖整个软件开发生命周期 (SDLC)</li><li>提供更丰富的研发数据分析场景，与用户共建 Dashboard，实现更进一步的开箱即用</li><li>提升灵活性，用户能够根据自身业务需求，轻松地自定义数据模型和指标</li><li>优化用户体验，降低安装、配置、收集的成本，使用户专注数据分析</li><li>增强系统可伸缩性, 提升大规模数据场景下的系统性能</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="社区建设方面">社区建设方面<a class="hash-link" href="#社区建设方面" title="标题的直接链接">​</a></h4><ul><li>组织多种多样的社区活动，积极进行线上和线下技术布道，吸引更多用户、开发者和开源爱好者参与到 DevLake 的社区中来</li><li>打造开放、友好的交流环境，完善和丰富 DevLake 相关内容体系，完善用户文档和贡献指南，降低用户使用和参与门槛，向社区提供更及时的响应，积极与用户互动，解决用户问题并进一步促进项目迭代</li><li>积极与其他开源项目和社区展开合作，让更多生态合作伙伴了解和参与到 DevLake 社区，共建繁荣生态</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="为什么加入-asf-孵化器">为什么加入 ASF 孵化器<a class="hash-link" href="#为什么加入-asf-孵化器" title="标题的直接链接">​</a></h3><p>首先，DevLake 相信 The Apache way 是社区成功之道，以人为本开放、社区高于代码等理念将帮助 DevLake 健康、持续地成长。</p><p>其次，DevLake 和数据基建相关，与 Apache 基金会的关注点高度契合。DevLake 期待与 Apache 生态的其他大数据开源项目共同发展，共建生态。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="导师介绍">导师介绍<a class="hash-link" href="#导师介绍" title="标题的直接链接">​</a></h3><ul><li><a href="https://github.com/WillemJiang" target="_blank" rel="noopener noreferrer">姜宁</a>：DevLake Champion，ASF Member，同时也今年当选的 Apache 董事</li><li><a href="https://github.com/terrymanu" target="_blank" rel="noopener noreferrer">张亮</a>：SphereEx 公司创始人 &amp; CEO，ASF Member，Apache ShardingSphere 创始人 &amp; PMC Chair</li><li><a href="https://github.com/dailidong" target="_blank" rel="noopener noreferrer">代立冬</a>：白鲸开源联合创始人，ASF Member，Apache DolphinScheduler PMC Chair</li><li><a href="https://github.com/sijie" target="_blank" rel="noopener noreferrer">郭斯杰</a>：ASF Member, PMC Member on Apache Pulsar，StreamNative 创始人 &amp; CEO</li><li><a href="https://github.com/felixcheung" target="_blank" rel="noopener noreferrer">Felix Cheung</a>： ASF Member，Apache Zeppelin、Spark、SuperSet、YuniKorn、Pinot 等项目 PMC，SafeGraph 技术高级副总裁</li><li><a href="https://github.com/jbonofre" target="_blank" rel="noopener noreferrer">Jean-Baptiste Onofré</a>：ASF Member，Karaf PMC Chair，ActiveMQ、Archiva、Aries、Beam、Brooklyn、Camel、Carbondata、Felix 等项目 PMC</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="导师寄语">导师寄语<a class="hash-link" href="#导师寄语" title="标题的直接链接">​</a></h3><ul><li><p>姜宁：非常高兴能够成为 DevLake 的开源孵化领路人，帮助 DevLake 加入的 ASF 孵化器。 DevLake 着力于解决软件研发领域数据收集，以及研发瓶颈分析的痛点问题。欢迎对提升软件研发效率感兴趣的小伙伴参与到 DevLake 的使用和开发中来，一同构建繁荣发展的社区生态。 </p></li><li><p>张亮：欢迎 Apache 孵化器的新成员 DevLake。它将使工程效能领域的发展更加开放和繁荣，进而推动整个领域的标准化进程。欢迎更多的贡献者参与 ASF 社区，望 DevLake 早日毕业！</p></li><li><p>代立冬：很高兴看到 DevLake 加入到 Apache 孵化器，DevLake 是一个专为开发团队分析和提高工程生产力的平台，欢迎广大的开发伙伴们一起参与让 DevLake 社区更加繁荣、早日成为顶级项目！</p></li><li><p>郭斯杰：祝贺 DevLake 进入 Apache 软件基金会孵化器，这是 DevLake 走向世界的一大步，期待有更多技术爱好者和用户加入，共建繁荣。祝社区快速成长成为顶级项目，成为研发数据平台的中流砥柱。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="如何参与-devlake-社区">如何参与 DevLake 社区？<a class="hash-link" href="#如何参与-devlake-社区" title="标题的直接链接">​</a></h3><p>DevLake 的发展离不开社区用户的支持，欢迎所有人参与社区建设，让 DevLake 越来越有生命力🥳</p><ul><li>加入社群<ul><li>加入 <a href="https://join.slack.com/t/devlake-io/shared_invite/zt-18uayb6ut-cHOjiYcBwERQ8VVPZ9cQQw" target="_blank" rel="noopener noreferrer">Slack</a> </li><li>点击下方代码仓库地址 &gt; Readme &gt; 扫描微信群二维码</li></ul></li><li>DevLake 代码仓库：<a href="https://github.com/apache/incubator-devlake/" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-devlake/</a></li><li>DevLake 官网：<a href="https://devlake.apache.org/" target="_blank" rel="noopener noreferrer">https://devlake.apache.org/</a></li><li>DevLake Podling Website：<a href="https://incubator.apache.org/projects/devlake.html" target="_blank" rel="noopener noreferrer">https://incubator.apache.org/projects/devlake.html</a></li><li>如何参与贡献：<a href="https://github.com/apache/incubator-devlake#how-to-contribute" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-devlake#how-to-contribute</a></li><li>订阅邮件列表了解动态：<a href="mailto:dev@devlake.incubator.apache.org" target="_blank" rel="noopener noreferrer">dev@devlake.incubator.apache.org</a></li></ul>]]></content:encoded>
            <category>devlake</category>
            <category>apache</category>
        </item>
        <item>
            <title><![CDATA[Apache DevLake是怎么跑起来的]]></title>
            <link>https://devlake.apache.org/zh/blog/how-apache-devlake-runs</link>
            <guid>how-apache-devlake-runs</guid>
            <pubDate>Wed, 18 May 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Apache DevLake 是一个DevOps数据收集和整合工具，通过 Grafana 为开发团队呈现出不同阶段的数据，让团队能够以数据为驱动改进开发流程。]]></description>
            <content:encoded><![CDATA[<p><a href="https://github.com/apache/incubator-devlake" target="_blank" rel="noopener noreferrer">Apache DevLake</a> 是一个DevOps数据收集和整合工具，通过 Grafana 为开发团队呈现出不同阶段的数据，让团队能够以数据为驱动改进开发流程。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="apache-devlake-架构概述">Apache DevLake 架构概述<a class="hash-link" href="#apache-devlake-架构概述" title="标题的直接链接">​</a></h3><ul><li>左边是<a href="https://devlake.apache.org/docs/DataModels/DataSupport" target="_blank" rel="noopener noreferrer">可集成的DevOps数据插件</a>，目前已有的插件包括 Github，Gitlab，JIRA，Jenkins，Tapd，Feishu 以及思码逸主打的代码分析引擎</li><li>中间是主体框架，通过主体框架运行插件中的子任务，完成数据的收集，扩展，并转换到领域层，用户可以通过 config-ui 或者 api 调用的形式来触发任务</li><li>RMDBS 目前支持 Mysql 和 PostgreSQL，后期还会继续支持更多的数据库</li><li>Grafana 可以通过sql语句生成团队需要的各种数据</li></ul><p><img loading="lazy" alt="Generated" src="/zh/assets/images/Aspose.Words.093a76ac-457b-4498-a472-7dbea580bca9.001-9fe996eee294ce1843bc3f126a1a7b89.png" width="567" height="310" class="img_E7b_"></p><blockquote><p>接下来我们就详细聊一聊系统是怎么跑起来的。</p></blockquote><h3 class="anchor anchorWithStickyNavbar_mojV" id="系统启动">系统启动<a class="hash-link" href="#系统启动" title="标题的直接链接">​</a></h3><p>在我们的 golang 程序启动之前，首先会自动调用各个 package 的 init() 方法，我们主要看看services 包的载入，下面的代码有详细注释：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 获取配置信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 获取到数据库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> runner</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewGormDb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Nested</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"db"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 配置时区</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithLocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UTC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 创建定时任务管理器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cronManager </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">location</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 初始化数据迁移</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">migration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 注册框架的数据迁移脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">migrationscripts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 载入插件，从cfg.GetString("PLUGIN_DIR")获取到的文件夹中载入所有.so文件，在LoadPlugins方法中，具体来讲，通过调用runner.LoadPlugins将pluginName:PluginMeta键值对存入到core.plugins中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> runner</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadPlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"PLUGIN_DIR"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Nested</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"plugin"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 执行数据迁移脚本，完成数据库框架层各个表的初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> migration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Background</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// call service init</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">pipelineServiceInit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="devlake的任务执行原理">DevLake的任务执行原理<a class="hash-link" href="#devlake的任务执行原理" title="标题的直接链接">​</a></h3><p><strong>Pipeline的运行流程</strong></p><p>在讲解Pipeline流程之前，我们需要先解释一下<a href="https://devlake.apache.org/docs/Glossary#blueprints" target="_blank" rel="noopener noreferrer">Blueprint</a>。</p><p>Blueprint是一个定时任务，包含了需要执行的子任务以及执行计划。Blueprint 的每一次执行记录是一条Historical Run（也称为 Pipeline），代表 DevLake 一次触发，通过一个或多个插件，完成了一个或多个数据收集转换的任务。</p><p><img loading="lazy" alt="Generated" src="/zh/assets/images/Aspose.Words.093a76ac-457b-4498-a472-7dbea580bca9.002-40065677c2b00df89eeaac1d9512f286.png" width="567" height="263" class="img_E7b_"></p><p>以下是 Pipeline 运行流程图：</p><p><img loading="lazy" alt="Generated" src="/zh/assets/images/Aspose.Words.093a76ac-457b-4498-a472-7dbea580bca9.003-d07631a740cb5b056d15a35627afef80.png" width="344" height="515" class="img_E7b_"></p><p>一个pipeline包含一个二维数组tasks，主要是为了保证一系列任务按预设顺序执行。如果下图中的 Stage3 的插件需要依赖其他插件准备数据（例如 refdiff 的运行需要依赖 gitextractor 和 github，数据源与插件的更多信息请看<a href="https://devlake.apache.org/docs/DataModels/DataSupport" target="_blank" rel="noopener noreferrer">文档</a>），那么 Stage 3 开始执行时，需要保证其依赖项已在 Stage1 和 Stage2 执行完成：</p><p><img loading="lazy" alt="Generated" src="/zh/assets/images/Aspose.Words.093a76ac-457b-4498-a472-7dbea580bca9.004-a6a550c4f00b232abc7b28e30738be09.png" width="567" height="238" class="img_E7b_"></p><p><strong>Task的运行流程</strong></p><p>在stage1，stage2，stage3中的各插件任务都是并行执行：</p><p><img loading="lazy" alt="Generated" src="/zh/assets/images/Aspose.Words.093a76ac-457b-4498-a472-7dbea580bca9.005-4d14031484d1272b4be8d7ff2f08d2a2.png" width="304" height="501" class="img_E7b_"></p><p><strong>接下来就是顺序执行插件中的子任务</strong></p><p><img loading="lazy" alt="Generated" src="/zh/assets/images/Aspose.Words.093a76ac-457b-4498-a472-7dbea580bca9.006-83ed245c2c8d805aca908814f0f0f5f9.png" width="331" height="617" class="img_E7b_"></p><ol><li>RunTask 之前的工作都是在准备 RunTask 方法需要的参数，比如 logger，db，context 等等。</li><li>RunTask 方法中主要是对数据库中的tasks进行状态更新，同时，准备运行插件任务的 options（把从 config-ui 传过来的 json 转成 map 传到 RunPluginTask 中）</li><li>RunPluginTask 首先通过 core.GetPlugin(pluginName) 获取到对应 <a href="#pm">PluginMeta</a>，然后通过 PluginMeta 获取到 <a href="#pt">PluginTask</a>，再执行 RunPluginSubTasks</li></ol><p><strong>每一个插件子任务的运行流程（涉及到的 interface 及 func 会在<a href="#DevLake%E4%B8%AD%E7%9A%84%E9%87%8D%E8%A6%81%E6%8E%A5%E5%8F%A3">下一节</a>详细阐述）</strong></p><p><img loading="lazy" alt="Generated" src="/zh/assets/images/Aspose.Words.093a76ac-457b-4498-a472-7dbea580bca9.007-09a5f7c401dfb5a557b10c3870d103fe.png" width="567" height="214" class="img_E7b_"></p><ol><li>通过调用SubTaskMetas()获取到所有插件所有的可用子任务<a href="#stm">subtaskMeta</a></li><li>通过<code>options["tasks"]</code>以及subtaskMeta组建需要执行的子任务集合subtaskMetas</li><li>计算总共多少个子任务</li><li>通过<code>helper.NewDefaultTaskContext</code>构建<a href="#tc">taskCtx</a></li><li>调用<code>pluginTask.PrepareTaskData</code>构建<a href="#td">taskData</a>，</li><li>接下来迭代subtaskMetas里面的所有子任务<ol><li>通过<code>taskCtx.SubTaskContext(subtaskMeta.Name)</code>获取到子任务的<a href="#sc">subtaskCtx</a></li><li>执行<a href="#step"><code>subtaskMeta.EntryPoint(subtaskCtx)</code></a></li></ol></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="devlake中的重要接口">DevLake中的重要接口<a class="hash-link" href="#devlake中的重要接口" title="标题的直接链接">​</a></h3><ol><li><a id="pm">PluginMeta</a>: 包含了插件最基本的两个方法，所有插件都需要实现，系统启动的时候存在core.plugins中，在执行插件任务的时候通过core.GetPlugin获取</li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PluginMeta </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">Description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">//PkgPath information will be lost when compiled as plugin(.so), this func will return that info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">RootPkgPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="2"><li><a id="pt">PluginTask</a>: 通过PluginMeta获取，插件实现这个方法之后，Framework就能直接运行子任务，而不是扔给插件自己去执行，最大的好处就是插件的子任务实现更加简单，在插件运行当中，我们也可以更容易的去干涉（比如增加日志等等）</li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PluginTask </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// return all available subtasks, framework will run them for you in order</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">SubTaskMetas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">SubTaskMeta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// based on task context and user input options, return data that shared among all subtasks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">PrepareTaskData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskCtx TaskContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="3"><li>每个插件还有一个<a id="td">taskData</a>，里面包含了配置选项，apiClient以及一些插件其它属性（比如github有Repo信息）</li><li><a id="stm">SubTaskMeta</a>: 一个子任务的元数据，每个子任务都会定义一个SubTaskMeta</li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> CollectMeetingTopUserItemMeta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SubTaskMeta</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"collectMeetingTopUserItem"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   EntryPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CollectMeetingTopUserItem</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   EnabledByDefault</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Collect top user meeting data from Feishu api"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="5"><li><a id="ec">ExecContext</a>: 定义了执行(子)任务需要的所有资源</li><li><a id="stc">SubTaskContext</a>: 定义了执行子任务所需要的资源（包含了ExecContext）</li><li><a id="tc">TaskContext</a>: 定义了执行插件任务所需要的资源（包含了ExecContext）。与SubTaskContext的区别在于SubTaskContext中的TaskContext()方法可以返回TaskContext，而TaskContext中的方法SubTaskContext(subtask string)方法可以返回SubTaskContext，子任务隶属于插件任务，所以把这两个Context进行了区分</li><li><a id="step">SubTaskEntryPoint</a>: 所有的插件子任务都需要实现这个函数，这样才能由框架层统一协调安排</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="后续">后续<a class="hash-link" href="#后续" title="标题的直接链接">​</a></h3><p>这篇文章介绍了 DevLake 的架构以及运行流程，还有三个核心 api<!-- -->_<!-- -->collector、api<!-- -->_<!-- -->extractor 和 data<!-- -->_<!-- -->convertor 将会在下一篇文章进行剖析。</p>]]></content:encoded>
            <category>devlake</category>
            <category>apache</category>
        </item>
        <item>
            <title><![CDATA[使用ants引发的死锁]]></title>
            <link>https://devlake.apache.org/zh/blog/deadlock-caused-by-using-ants</link>
            <guid>deadlock-caused-by-using-ants</guid>
            <pubDate>Sat, 30 Apr 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[1. 背景]]></description>
            <content:encoded><![CDATA[<h3 class="anchor anchorWithStickyNavbar_mojV" id="1-背景">1. 背景<a class="hash-link" href="#1-背景" title="标题的直接链接">​</a></h3><p>我们的项目有大量的api请求由goroutine完成，所以我们需要引入一个pool来节省频繁创建goroutine所造成的的开销，同时也可以更简易的调度goroutine，在对github上多个协程池的对比后，我们最终选定了<a href="https://github.com/panjf2000/ants" target="_blank" rel="noopener noreferrer">ants</a>作为我们的调度管理pool。</p><ol><li>最近在测试中偶然发现系统出现了“死锁”的情况，进而采取断网的方式发现“死锁”在极端情况下是稳定出现，经过满篇的log，break，最终把问题定位到了ants的submit方法。这个问题来自于在使用ants pool的过程中，为了实现重试，我们在方法中又递归调用了方法本身，也就是submit task内部又submit一个task，下面是简化后的代码：</li></ol><div class="codeBlockContainer_I0IT language-Go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">func (apiClient *ApiAsyncClient) DoAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   retry int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return apiClient.scheduler.Submit(func() error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      _, err := apiClient.Do()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         if retry &lt; apiClient.maxRetry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return apiClient.DoAsync(retry+1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在上面的代码块中，可以看到return apiClient.DoAsync(retry+1)这一步递归调用了自己，即在submit中又调用了submit</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-深入ants分析">2. 深入ants分析<a class="hash-link" href="#2-深入ants分析" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/zh/assets/images/ants_source_code_1-dbc90cd562952b6434590b8ae7121255.png" width="333" height="231" class="img_E7b_"></p><ul><li>在上面submit源码中可以看到，首先是通过retrieveWorker回去一个worker，然后把task放入到worker的task channel当中，很简单，也看不出来为什么会“dead lock”，没办法，去到retrieveWorker</li></ul><div class="codeBlockContainer_I0IT language-Go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// retrieveWorker returns a available worker to run the tasks.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (p *Pool) retrieveWorker() (w *goWorker) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spawnWorker := func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  w = p.workerCache.Get().(*goWorker)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  w.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> p.lock.Lock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> w = p.workers.detach()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> if w != nil { // first try to fetch the worker from the queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p.lock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> } else if capacity := p.Cap(); capacity == -1 || capacity &gt; p.Running() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // if the worker queue is empty and we don't run out of the pool capacity,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // then just spawn a new worker goroutine.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p.lock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spawnWorker()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> } else { // otherwise, we'll have to keep them blocked and wait for at least one worker to be put back into pool.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if p.options.Nonblocking {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   p.lock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> retry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if p.options.MaxBlockingTasks != 0 &amp;&amp; p.blockingNum &gt;= p.options.MaxBlockingTasks {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   p.lock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p.blockingNum++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p.cond.Wait() // block and wait for an available worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p.blockingNum--</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var nw int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if nw = p.Running(); nw == 0 { // awakened by the scavenger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   p.lock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if !p.IsClosed() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spawnWorker()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if w = p.workers.detach(); w == nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if nw &lt; capacity {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p.lock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spawnWorker()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   goto retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p.lock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="img" src="/zh/assets/images/ants_source_code_flowchart-6f51973ac906b9029502a2c9063df6ad.png" width="1280" height="481" class="img_E7b_"></p><ul><li>这个方法的大概流程就是先对pool上锁，然后从pool的worker队列中去取一个worker，detach其实就是返回了worker，并且把这个worker从队列中删除掉了，接下来有三种情况<ul><li>如果成功取到worker，解锁p，返回取到的worker</li><li>如果worker队列是空的并且pool的容量没有耗尽，就解锁pool并生成一个新的worker返回给submit</li><li>最后一种情况就是pool容量耗尽了，worker队列也没有空闲的worker，那就要根据我们创建pool时传入的参数来决定下一步情况了<ul><li>首先说一下这里涉及的两个重要参数，一个是capacity，这个值如果在new pool的时候不设置，会是MaxInt32，相当于无限制的goroutine，但是情况不同的是，我们会首先复用空闲的worker，还可以定时清空多余的空闲worker，blockingNum为正在等待的goroutine，初始为0</li><li>如果设置了Nonblocking为true，直接解锁，返回nil，submit就会直接返回一个错误ErrPoolOverload，代表pool超负荷了，不做任何其他处理，submit失败，结束~~</li><li>另一种情况就是没有设置Nonblocking，默认为false，就进入到了一个retry标签，这里面就涉及到了另一个创建pool时候的参数MaxBlockingTasks，这个MaxBlockingTasks就是一个threshold<ul><li>首先判断如果设置了MaxBlockingTasks并且当前blockingNum大于或者等于MaxBlockingTasks，那么直接解锁pool并且返回nil，submit失败，结束~~</li><li>上面的条件不满足，则首先blockingNum++，然后开始wait一直到有worker摸完鱼回来工作，则blockingNum--。问题就在这里了！！！如果所有的worker都在工作（也许是看起来在工作，实际上在摸鱼），这里就会一直wait()，也就是我们自己代码中return后面的DoAsync会一直wait()，从我们自己的项目来讲，就是所有worker这个时候都在submit一个新的task到同一个pool中，而这个时候pool已经满了，导致所有worker都阻塞在了这里，“死锁”也就出现了</li></ul></li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-最后聊几句自己对于golang内存模型的理解">3. 最后聊几句自己对于golang内存模型的理解<a class="hash-link" href="#3-最后聊几句自己对于golang内存模型的理解" title="标题的直接链接">​</a></h3><ol><li>go的调度流程本质上是一个生产-消费的过程，我们利用go func是生产了一个task放到队列中，由系统线程从队列中获取协程然后执行</li><li>讲到go的调度流程，咱们就不能不说一下go的MPG（分别解释一下，就不做深入了，如果有人看，后期再努力整理一份详细聊聊）<ol><li>M 代表着一个内核线程，也可以称为一个工作线程，所有的goroutine都是跑在M之上的</li><li>P可以理解为一个逻辑处理器，主要由P来执行goroutine</li><li>G就是go func封装的这个方法</li></ol></li><li>真正的并发数是由GOMAXPROCS来决定的，并不是提交多少goroutine，并发数就是多少，GOMAXPROCS是由机器的cpu核数来决定的</li><li>所以回到第2部分，pool.cond.wait等待的是绑定上一个goroutine，和其他语言的等待线程具有相似却完全不同的意义，每一个worker是一个G，pool也就是一个队列，而M会从队列中获取可以执行的G，当所有的G都在等待创建新的G时，M全部都处于空闲状态</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-解决方案">4. 解决方案<a class="hash-link" href="#4-解决方案" title="标题的直接链接">​</a></h3><ol><li>当然，最靠谱的应该是尽量避免类似这样的递归调用操作</li><li>如果实在不行，可以考虑添加一个sub pool，作为次级队列，让递归生成的G可以在sub pool里等待空闲的M来处理</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-对比不同size的pool和两个pool的内存alloc_space和cpu开销">5. 对比不同size的pool和两个pool的内存（alloc_space）和CPU开销<a class="hash-link" href="#5-对比不同size的pool和两个pool的内存alloc_space和cpu开销" title="标题的直接链接">​</a></h3><table><thead><tr><th>Pool size</th><th>CPU(ants)%</th><th>CPU(runtime.gcBgMarkWorker)%</th><th>CPU(runtime.mcall)%</th><th>内存(runtime.allocm)kB</th><th>内存(runtime.gcBgMarkWorker)kB</th><th>内存(root)</th></tr></thead><tbody><tr><td>Two pools(158, 632)</td><td>27.98</td><td>7.73</td><td>25.44</td><td>2050.25</td><td>512.02</td><td>8798</td></tr><tr><td>Pool 158</td><td>28.11</td><td>6.61</td><td>25.08</td><td>2050</td><td></td><td>6661</td></tr><tr><td>Pool 1580</td><td>27.41</td><td>12.96</td><td>23.17</td><td>3075.38</td><td></td><td>10264</td></tr><tr><td>Pool 7900</td><td>25.89</td><td>9.82</td><td>22.52</td><td>3587.94</td><td></td><td>5725</td></tr><tr><td>Pool 790000</td><td>25.12</td><td>12.79</td><td>23.44</td><td>3075.38</td><td></td><td>9748</td></tr></tbody></table><p>runtime.gcBgMarkWorker: 用于标记垃圾对象</p><p>从上面的表格可以看到，可能存在多核的影响，所以对于我们公司现在需要的并发数量级来讲，pool的size对系统影响并不大。</p>]]></content:encoded>
            <category>devlake</category>
            <category>ants</category>
        </item>
    </channel>
</rss>