<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache DevLake - Open-Source Dev Data Platform for Productivity RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache DevLake - Open-Source Dev Data Platform for Productivity Atom Feed"><title data-rh="true">Setting up Devlake in AWS ECS cluster using Terraform | Apache DevLake - Open-Source Dev Data Platform for Productivity</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://devlake.apache.org/zh/blog/setting-up-devlake-in-aws-ecs-cluster-using-terraform"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="keywords" content="Engineering Productivity, Open-Source Engineering, Open-Source Integration Tools, Data Integrates Platform, Open-Source Dev Platform, Open-Source Data Integrates, DevOps Tools Integrates, Open-Source DevOps Tools"><meta data-rh="true" property="og:title" content="Setting up Devlake in AWS ECS cluster using Terraform | Apache DevLake - Open-Source Dev Data Platform for Productivity"><meta data-rh="true" name="description" content="This guide provides an alternative to Devlake&#x27;s Kubernetes setup and will walk you through setting up DevLake in an AWS ECS (Elastic Container Service) cluster using Terraform, providing you with a scalable and maintainable infrastructure as code solution that is also cost effective."><meta data-rh="true" property="og:description" content="This guide provides an alternative to Devlake&#x27;s Kubernetes setup and will walk you through setting up DevLake in an AWS ECS (Elastic Container Service) cluster using Terraform, providing you with a scalable and maintainable infrastructure as code solution that is also cost effective."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-04-03T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/tinazhouhui"><meta data-rh="true" property="article:tag" content="DevLake,AWS,ECS,Terraform"><link data-rh="true" rel="icon" href="/zh/img/logo.svg"><link data-rh="true" rel="canonical" href="https://devlake.apache.org/zh/blog/setting-up-devlake-in-aws-ecs-cluster-using-terraform"><link data-rh="true" rel="alternate" href="https://devlake.apache.org/blog/setting-up-devlake-in-aws-ecs-cluster-using-terraform" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://devlake.apache.org/zh/blog/setting-up-devlake-in-aws-ecs-cluster-using-terraform" hreflang="zh"><link data-rh="true" rel="alternate" href="https://devlake.apache.org/blog/setting-up-devlake-in-aws-ecs-cluster-using-terraform" hreflang="x-default"><link rel="stylesheet" href="/zh/assets/css/styles.ddc6bf33.css">
<link rel="preload" href="/zh/assets/js/runtime~main.cbfd5bb5.js" as="script">
<link rel="preload" href="/zh/assets/js/main.e04dcdeb.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logo.svg" alt="apache devlake" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh/img/logo.svg" alt="apache devlake" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Apache DevLake</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/Overview/Introduction">Next</a></li><li><a class="dropdown__link" href="/zh/docs/v1.0/Overview/Introduction">v1.0 (Stable)</a></li><li><a class="dropdown__link" href="/zh/docs/v0.21/Overview/Introduction">v0.21</a></li><li><a class="dropdown__link" href="/zh/docs/v0.20/Overview/Introduction">v0.20</a></li><li><a class="dropdown__link" href="/zh/docs/v0.19/Overview/Introduction">v0.19</a></li><li><a class="dropdown__link" href="/zh/docs/v0.18/Overview/Introduction">v0.18</a></li><li><a class="dropdown__link" href="/zh/docs/v0.17/Overview/Introduction">v0.17</a></li><li><a class="dropdown__link" href="/zh/docs/v0.16/Overview/Introduction">v0.16</a></li><li><a class="dropdown__link" href="/zh/docs/v0.15/Overview/Introduction">v0.15</a></li></ul></div><a class="navbar__item navbar__link" href="/zh/livedemo/EngineeringLeads/DORA">Use Cases</a><a class="navbar__item navbar__link" href="/zh/community/">Community</a><a class="navbar__item navbar__link" href="/zh/team">Team</a><a class="navbar__item navbar__link" href="/zh/blogOverview">Blog</a><a href="https://github.com/apache/incubator-devlake" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a class="navbar__item navbar__link" href="/zh/download">Download</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zh/blog/setting-up-devlake-in-aws-ecs-cluster-using-terraform">Setting up Devlake in AWS ECS cluster using Terraform</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Quick-Start-Guide-Setup-Your-First-Engineering-Metrics-Dashboard-in-5-Minutes">Quick Start Guide: Setup Your First Engineering Metrics Dashboard in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/DevLake-Playground-How-to-explore-your-data">DevLake Playground: How to explore your data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/compatibility-of-apache-devLake-with-postgreSQL">Compatibility of Apache DevLake with PostgreSQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/how-DevLake-is-up-and-running">How DevLake is Up and Running</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/apache-welcomes-devlake">Apache Incubator Welcomes DevLake, A Dev-Data Platform Serving Developers</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Setting up Devlake in AWS ECS cluster using Terraform</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-04-03T00:00:00.000Z" itemprop="datePublished">2025年4月3日</time> · <!-- -->阅读需 10 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/tinazhouhui" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/63497846?v=4" alt="TinaZhouHui"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tinazhouhui" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TinaZhouHui</span></a></div><small class="avatar__subtitle" itemprop="description">Devlake Enthusiast</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>This guide provides an alternative to Devlake&#x27;s Kubernetes setup and will walk you through setting up DevLake in an AWS ECS (Elastic Container Service) cluster using Terraform, providing you with a scalable and maintainable infrastructure as code solution that is also cost effective.</p><p>Basic knowledge of AWS ECS, Terraform, and your network where your cluster will be deployed is necessary to follow this guide effectively.</p><h1>Setting up terraform structure</h1><p>To configure devlake, we will use a terraform module and pass the necessary variables. The final structure of the module would be something like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform-root/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── devlake/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── rds.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── alb.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── efs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── iam.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── logs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── security.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── providers.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">As we go in this tutorial, we will be populating individual files.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The AWS provider that is being used is <code>version = &quot;~&gt; 5.91.0&quot;</code>.</p><p>Fist of, lets populate the <code>variables.tf</code>:</p><div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;aws_region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;AWS region where resources will be created&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;YOUR-AWS-REGION&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;tag_name&quot; { # for cost monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Name tag for all DevLake resources&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>High level architecture</h1><p>The goal is to create an AWS ECS cluster running on fargate spot instances, with an RDS mysql database and efs for grafana as a storage layer. We also need an application load balancer on top which we can optionally configure authentication (like OKTA).</p><p><img loading="lazy" alt="Architecture Image" src="/zh/assets/images/architecture-1587b6206b9702c0989bfb3131be8e1a.png" width="895" height="671" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage">Storage<a class="hash-link" href="#storage" title="标题的直接链接">​</a></h2><p>Let&#x27;s start with provisioning the necessary storage layer. First of, let&#x27;s create a database and tis security group in the <code>rds.tf</code> file. For that we will need the subnets that you want to deploy your database, the vpc id and the database password (adding them to the <code>variable.tf</code>):</p><div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;devlake-rds&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source  = &quot;terraform-aws-modules/rds/aws&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version = &quot;~&gt; 6.10.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  identifier = &quot;devlake-db&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  engine               = &quot;mysql&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  engine_version       = &quot;8.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_class       = &quot;db.t3.micro&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allocated_storage    = 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  major_engine_version = &quot;8.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  family               = &quot;mysql8.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  manage_master_user_password = false </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  db_name                     = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username                    = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password                    = var.db_password # todo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  port                        = 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  create_db_subnet_group = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_ids             = var.private_subnets # todo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_security_group_ids = [aws_security_group.rds.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  skip_final_snapshot = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled_cloudwatch_logs_exports = [&quot;error&quot;, &quot;general&quot;, &quot;slowquery&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  create_cloudwatch_log_group     = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;rds&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = &quot;devlake-rds&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Security group for DevLake RDS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id      = var.vpc_id # todo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port       = 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port         = 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol        = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.ecs_tasks.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And also let&#x27;s create the EFS for grafana and its own security group in <code>efs.tf</code>. Since we know that grafana will also need to access this efs, lets go ahead and also create the access point and mount targets:</p><div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_efs_file_system&quot; &quot;grafana&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creation_token = &quot;grafana-storage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encrypted      = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle_policy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transition_to_ia = &quot;AFTER_30_DAYS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_efs_access_point&quot; &quot;grafana&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file_system_id = aws_efs_file_system.grafana.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  posix_user {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gid = 472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uid = 472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  root_directory {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path = &quot;/var/lib/grafana&quot; # from devlake documentation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    creation_info { # this is necessary to give write permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      owner_gid   = 472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      owner_uid   = 472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      permissions = &quot;755&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_efs_mount_target&quot; &quot;grafana&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count           = length(var.private_subnets)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file_system_id  = aws_efs_file_system.grafana.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_id       = var.private_subnets[count.index]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  security_groups = [aws_security_group.efs.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;efs&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = &quot;grafana-efs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Security group for Grafana EFS mount targets&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id      = var.vpc_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port       = 2049</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port         = 2049</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol        = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.ecs_tasks.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cluster">Cluster<a class="hash-link" href="#cluster" title="标题的直接链接">​</a></h2><p>Let&#x27;s start with creating a cluster in the module&#x27;s <code>main.tf</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_ecs_cluster&quot; &quot;devlake&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;devlake-cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  setting {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name  = &quot;containerInsights&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value = &quot;enabled&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We also need to make sure that the services can talk to each other, therefore we need to create a service discovery namespace. This is crucial to allow for proper host resolution (side note, I also tested this with service connect and it did not work):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_service_discovery_private_dns_namespace&quot; &quot;devlake&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = &quot;devlake-ns&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Private DNS namespace for DevLake services&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc         = var.vpc_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># one for each service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_service_discovery_service&quot; &quot;devlake&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;devlake&quot; // &quot;config-ui&quot; // &quot;grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dns_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace_id = aws_service_discovery_private_dns_namespace.devlake.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dns_records {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ttl  = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type = &quot;A&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    routing_policy = &quot;MULTIVALUE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  health_check_custom_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    failure_threshold = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="permissions">Permissions<a class="hash-link" href="#permissions" title="标题的直接链接">​</a></h3><p>We also need to create IAM roles with necessary permissions to run our cluster. And a separate task role for the grafana container for efs permissions:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;ecs_task_execution_role&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;devlake-ecs-task-execution-role&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assume_role_policy = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version = &quot;2012-10-17&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Statement = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Action = &quot;sts:AssumeRole&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Effect = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Principal = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Service = &quot;ecs-tasks.amazonaws.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_task_execution_role_policy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = aws_iam_role.ecs_task_execution_role.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_task_execution_role_policy_cloudwatch&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = aws_iam_role.ecs_task_execution_role.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/CloudWatchLogsFullAccess&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IAM Task Role for Grafana container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;grafana_task_role&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;devlake-grafana-task-role&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assume_role_policy = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version = &quot;2012-10-17&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Statement = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Action = &quot;sts:AssumeRole&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Effect = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Principal = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Service = &quot;ecs-tasks.amazonaws.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Policy allowing Grafana task to access EFS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role_policy&quot; &quot;grafana_efs_access_policy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;grafana-efs-access-policy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role = aws_iam_role.grafana_task_role.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version = &quot;2012-10-17&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Statement = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Effect = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Action = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;elasticfilesystem:ClientMount&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;elasticfilesystem:ClientWrite&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;elasticfilesystem:DescribeAccessPoints&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;elasticfilesystem:DescribeFileSystems&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Resource = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-definition">Task definition<a class="hash-link" href="#task-definition" title="标题的直接链接">​</a></h3><p>Since the task definition is more or less identical, I will provide an example for one and just the differences in configuration for others.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_ecs_task_definition&quot; &quot;devlake&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  family                   = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_mode             = &quot;awsvpc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  requires_compatibilities = [&quot;FARGATE&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cpu                      = 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory                   = 512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  execution_role_arn       = aws_iam_role.ecs_task_execution_role.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container_definitions = jsonencode([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name  = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image = &quot;devlake.docker.scarf.sh/apache/devlake:v1.0.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      portMappings = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name          = &quot;devlake-port&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          containerPort = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hostPort      = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          protocol      = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      environment = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;DB_URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;mysql://devlake:${var.db_password}@${module.devlake-rds.db_instance_endpoint}/devlake?charset=utf8mb4&amp;parseTime=True&amp;loc=UTC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;LOGGING_DIR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;/app/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;TZ&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;UTC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;ENCRYPTION_SECRET&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = var.encryption_secret # your encryption secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      logConfiguration = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logDriver = &quot;awslogs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        options = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-group&quot;         = aws_cloudwatch_log_group.devlake.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-region&quot;        = var.aws_region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-stream-prefix&quot; = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>for config-ui, all is same except for the definition. Take a note on how the endpoints look like, as they are using the namespace we created before:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_ecs_task_definition&quot; &quot;config_ui&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  family                   = &quot;config-ui&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container_definitions = jsonencode([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name  = &quot;config-ui&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image = &quot;devlake.docker.scarf.sh/apache/devlake-config-ui:latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      portMappings = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name          = &quot;config-ui-port&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          containerPort = 4000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hostPort      = 4000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          protocol      = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      environment = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;name&quot; : &quot;DEVLAKE_ENDPOINT&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;value&quot; : &quot;devlake.devlake-ns:8080&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;GRAFANA_ENDPOINT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;grafana.devlake-ns:3000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;TZ&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;UTC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      logConfiguration = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logDriver = &quot;awslogs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        options = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-group&quot;         = aws_cloudwatch_log_group.config_ui.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-region&quot;        = var.aws_region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-stream-prefix&quot; = &quot;config-ui&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and for grafana, we need to define the task role as well as the volume mount:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_ecs_task_definition&quot; &quot;grafana&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  family                   = &quot;grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  task_role_arn            = aws_iam_role.grafana_task_role.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container_definitions = jsonencode([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name  = &quot;grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image = &quot;devlake.docker.scarf.sh/apache/devlake-dashboard:v1.0.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      portMappings = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name          = &quot;grafana-port&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          containerPort = 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hostPort      = 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          protocol      = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      environment = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;GF_SERVER_ROOT_URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;https://devlake.${var.domain_name}/grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;TZ&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;UTC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;MYSQL_URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = module.devlake-rds.db_instance_endpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;MYSQL_DATABASE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;MYSQL_USER&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = &quot;MYSQL_PASSWORD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = var.db_password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPoints = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          sourceVolume  = &quot;grafana-storage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          containerPath = &quot;/var/lib/grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          readOnly      = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      logConfiguration = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logDriver = &quot;awslogs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        options = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-group&quot;         = aws_cloudwatch_log_group.grafana.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-region&quot;        = var.aws_region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;awslogs-stream-prefix&quot; = &quot;grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volume {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;grafana-storage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    efs_volume_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      file_system_id     = aws_efs_file_system.grafana.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      root_directory     = &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      transit_encryption = &quot;ENABLED&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      authorization_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access_point_id = aws_efs_access_point.grafana.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        iam             = &quot;ENABLED&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="security">Security<a class="hash-link" href="#security" title="标题的直接链接">​</a></h3><p>To create the service we also need to create a task security group in <code>security.tf</code>. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;ecs_tasks&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = &quot;devlake-ecs-tasks&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Security group for ECS tasks&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id      = var.management_vpc.vpc_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port   = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port     = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;Allow traffic from other ECS tasks to DevLake API&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  egress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port   = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port     = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol    = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We also need to add ingress rules to the RDS and EFS security groups in <code>rds.tf</code> and <code>efs.tf</code> so that the tasks can reach these services.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;rds&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port       = 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port         = 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol        = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.ecs_tasks.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;efs&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port       = 2049</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port         = 2049</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol        = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.ecs_tasks.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="logs">Logs<a class="hash-link" href="#logs" title="标题的直接链接">​</a></h3><p>To ensure proper monitoring and debugging capabilities, we&#x27;ll set up CloudWatch log groups for each service. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_cloudwatch_log_group&quot; &quot;devlake&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name              = &quot;/ecs/devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retention_in_days = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_cloudwatch_log_group&quot; &quot;config_ui&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name              = &quot;/ecs/config-ui&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retention_in_days = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_cloudwatch_log_group&quot; &quot;grafana&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name              = &quot;/ecs/grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retention_in_days = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="services">Services<a class="hash-link" href="#services" title="标题的直接链接">​</a></h3><p>Now that we have our infrastructure and task definitions set up, let&#x27;s create the ECS services. We&#x27;ll deploy three services: DevLake, Config UI, and Grafana. Each service will use Fargate Spot instances for cost optimization and will be configured with service discovery for internal communication.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_ecs_service&quot; &quot;devlake&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name            = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster         = aws_ecs_cluster.devlake.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  task_definition = aws_ecs_task_definition.devlake.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  desired_count   = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  health_check_grace_period_seconds = 120 # 2 minutes grace period for startup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity_provider_strategy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base              = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weight            = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capacity_provider = &quot;FARGATE_SPOT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnets         = var.management_vpc.private_subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.ecs_tasks.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configure Service Discovery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_registries {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registry_arn = aws_service_discovery_service.devlake.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deployment_circuit_breaker {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rollback = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configure deployment settings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deployment_maximum_percent         = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deployment_minimum_healthy_percent = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  propagate_tags = &quot;SERVICE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Take a note of the deployment setting in devlake service configuration. This is not needed for config ui or grafana, but only for devlake as only one instance od devlake can connect to DB, therefore we need to first kill the instance completely before starting a new one.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_ecs_service&quot; &quot;config_ui&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name            = &quot;config-ui&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  task_definition = aws_ecs_task_definition.config_ui.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_registries {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registry_arn = aws_service_discovery_service.config_ui.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Wait for DevLake to be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [aws_ecs_service.devlake]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_ecs_service&quot; &quot;grafana&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name            = &quot;grafana&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  task_definition = aws_ecs_task_definition.grafana.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_registries {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registry_arn = aws_service_discovery_service.grafana.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Wait for both DevLake and Config UI to be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [aws_ecs_service.devlake, aws_ecs_service.config_ui]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point your containers should be up and running, without any errors regarding DB connection or write permissions to efs. Now we need to setup the load balancer and domain name.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="load-balancer">Load balancer<a class="hash-link" href="#load-balancer" title="标题的直接链接">​</a></h2><p>Load balancer helps us route secure traffic to correct containers. We want to have a human readable url, like <a href="https://devlake.YOUR-DOMAIN.com" target="_blank" rel="noopener noreferrer">https://devlake.YOUR-DOMAIN.com</a> to access config ui and <a href="https://devlake.YOUR-DOMAIN.com/grafana" target="_blank" rel="noopener noreferrer">https://devlake.YOUR-DOMAIN.com/grafana</a> to access grafana dashboards.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="security-1">Security<a class="hash-link" href="#security-1" title="标题的直接链接">​</a></h3><p>Firts we need to create a security group for our alb in <code>security.tf</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;alb&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = &quot;devlake-alb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Security group for DevLake ALB&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id      = var.vpc_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port   = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port     = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;Allow HTTP traffic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port   = 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port     = 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;Allow HTTPS traffic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  egress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port   = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port     = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol    = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;Allow all outbound traffic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We also need to allow traffic from alb to the task security groups. This creates a secure path for external traffic to reach our services:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;ecs_tasks&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port       = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port         = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol        = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.alb.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description     = &quot;Allow traffic from ALB to DevLake API&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port       = 4000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port         = 4000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol        = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.alb.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description     = &quot;Allow traffic from ALB to DevLake UI&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port       = 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port         = 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol        = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups = [aws_security_group.alb.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description     = &quot;Allow traffic from ALB to Grafana UI&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificate">Certificate<a class="hash-link" href="#certificate" title="标题的直接链接">​</a></h3><p>To create an alb we also need a valid certificate. The certificate must be in the same region as the alb. This are probably created outside of the devlake module.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_acm_certificate&quot; &quot;devlake_cert&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  domain_name       = &quot;*.YOUR-DOMAIN.COM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation_method = &quot;DNS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create_before_destroy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = &quot;devlake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_route53_record&quot; &quot;cert_validation&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for dvo in aws_acm_certificate.devlake_cert.domain_validation_options : dvo.domain_name =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name   = dvo.resource_record_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      record = dvo.resource_record_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type   = dvo.resource_record_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow_overwrite = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zone_id         = YOUR_DOMAIN_ROUTE53.zone_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name            = each.value.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type            = each.value.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  records         = [each.value.record]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ttl             = 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="alb">ALB<a class="hash-link" href="#alb" title="标题的直接链接">​</a></h3><p>To create alb, we need two variables - public subnets and certificate created in the previous step. </p><p>Target groups are essential components that route traffic to our ECS tasks. We&#x27;ll create two target groups:</p><ol><li>Grafana target group - routes traffic to port 3000 and checks health at <code>/api/health</code></li><li>Config UI target group - routes traffic to port 4000 and checks health at the root path <code>/</code></li></ol><p>The health checks ensure that traffic is only routed to healthy containers, maintaining service reliability.</p><p>Listeners define how the ALB routes incoming traffic to our target groups. </p><p>The HTTPS listener uses our ACM certificate and routes traffic based on host headers:</p><ul><li><code>devlake.${var.domain_name}/grafana*</code> → Grafana target group</li><li><code>devlake.${var.domain_name}</code> → Config UI target group</li></ul><p>This setup ensures secure access to our services while maintaining proper routing based on the requested paths.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;devlake_alb&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source  = &quot;terraform-aws-modules/alb/aws&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version = &quot;~&gt; 9.13.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;devlake-alb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  load_balancer_type = &quot;application&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  internal           = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  security_groups    = [aws_security_group.alb.id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnets            = var.public_subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id             = var.vpc_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  listeners = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    https = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port            = 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol        = &quot;HTTPS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ssl_policy      = &quot;ELBSecurityPolicy-TLS13-1-2-Res-2021-06&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      certificate_arn = var.certificate_arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # default action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      forward = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        target_group_key = &quot;devlake-config-ui-tg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rules = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grafana = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          priority = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          actions = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type             = &quot;forward&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            target_group_key = &quot;devlake-grafana-tg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          conditions = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            host_header = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              values = [&quot;devlake.${var.domain_name}&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path_pattern = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              values = [&quot;/grafana&quot;, &quot;/grafana/*&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target_groups = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;devlake-grafana-tg&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name        = &quot;devlake-grafana-tg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol    = &quot;HTTP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port        = 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      target_type = &quot;ip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      health_check = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled             = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interval            = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path                = &quot;/api/health&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port                = &quot;traffic-port&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timeout             = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        healthy_threshold   = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unhealthy_threshold = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matcher             = &quot;200&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      create_attachment = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;devlake-config-ui-tg&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name        = &quot;devlake-config-ui-tg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol    = &quot;HTTP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port        = 4000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      target_type = &quot;ip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      health_check = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled             = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interval            = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path                = &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port                = &quot;traffic-port&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timeout             = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        healthy_threshold   = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unhealthy_threshold = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matcher             = &quot;200&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      create_attachment = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = var.tag_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dns-records">DNS Records<a class="hash-link" href="#dns-records" title="标题的直接链接">​</a></h3><p>Finally, to use a human readable url, we need to create DNS records in our route53 that points to our alb. For simplicity&#x27;s sake, I am referencing directly the alb module&#x27;s outputs, in reality you will probably need to ooutput these from the devlake module itself: </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_route53_record&quot; &quot;devlake&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zone_id = YOUR_DOMAIN_ROUTE53.zone_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name    = &quot;devlake.YOUR-DOMAIN.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = &quot;A&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alias {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                   = module.devlake_alb.dns_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zone_id                = module.devlake_alb.zone_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    evaluate_target_health = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And thats it, you should be able to access devlake on <a href="https://devlake.YOUR-DOMAIN.com" target="_blank" rel="noopener noreferrer">https://devlake.YOUR-DOMAIN.com</a>!</p><h1>Cost breakdown</h1><p> If you want to monitor your costs, first of you need to provide tags with all your resources and second you need to <a href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/activating-tags.html" target="_blank" rel="noopener noreferrer">activate the tag on aws</a> so it is registered. </p><p><img loading="lazy" alt="Cost breakdown Image" src="/zh/assets/images/cost-7efbeef1e68a962824a03e24db631d27.png" width="550" height="490" class="img_ev3q"></p><p>The daily cost is stable on aroun <code>$1.51</code> a day, which gives about <code>$45</code> a month. The cost does not include the route53 domain though.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/dev-lake">DevLake</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/aws">AWS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/ecs">ECS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/terraform">Terraform</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-devlake-website/edit/main/blog/2025-04-03-setting-up-devlake-in-aws-ecs-cluster-using-terraform/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/zh/blog/Quick-Start-Guide-Setup-Your-First-Engineering-Metrics-Dashboard-in-5-Minutes"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Quick Start Guide: Setup Your First Engineering Metrics Dashboard in 5 Minutes</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#storage" class="table-of-contents__link toc-highlight">Storage</a></li><li><a href="#cluster" class="table-of-contents__link toc-highlight">Cluster</a><ul><li><a href="#permissions" class="table-of-contents__link toc-highlight">Permissions</a></li><li><a href="#task-definition" class="table-of-contents__link toc-highlight">Task definition</a></li><li><a href="#security" class="table-of-contents__link toc-highlight">Security</a></li><li><a href="#logs" class="table-of-contents__link toc-highlight">Logs</a></li><li><a href="#services" class="table-of-contents__link toc-highlight">Services</a></li></ul></li><li><a href="#load-balancer" class="table-of-contents__link toc-highlight">Load balancer</a><ul><li><a href="#security-1" class="table-of-contents__link toc-highlight">Security</a></li><li><a href="#certificate" class="table-of-contents__link toc-highlight">Certificate</a></li><li><a href="#alb" class="table-of-contents__link toc-highlight">ALB</a></li><li><a href="#dns-records" class="table-of-contents__link toc-highlight">DNS Records</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/GettingStarted">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/DataModels/DevLakeDomainLayerSchema">Data Models</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/Metrics">Engineering Metrics</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/devlake-io/shared_invite/zt-2ox842kuu-_6x3Lwdj88YpzKhMRpgnMg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-devlake/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issue Tracker</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-devlake-website/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issue Tracker For Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/incubator-devlake" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/ApacheDevLake" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/community/trademark">Trademark Guidelines</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <div style="margin-top: 20px">
          <a href="https://incubator.apache.org/" target="_blank"><img style="height:40px; margin-bottom: 10px; margin-top: 10px" alt="Apache Software Foundation" src="/img/apache-incubator.svg"></a>
          <p style="text-align:left; font-weight: 300; font-size: 0.8em;">Apache DevLake is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
          <p style="text-align:left; font-weight: 300; font-size: 0.8em;">Copyright ©2025 Apache DevLake, DevLake, Apache, the Apache feather logo and the Apache DevLake project logo are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
        </div> 
        </div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.cbfd5bb5.js"></script>
<script src="/zh/assets/js/main.e04dcdeb.js"></script>
</body>
</html>